% KPD=[1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;1,1,1;0.998222365869425,0.992889463477699,0.923076923076923;0.996444731738849,0.985778926955398,0.846153846153846;0.994667097608274,0.978668390433096,0.769230769230769;0.992889463477699,0.971557853910795,0.692307692307692;0.991111829347124,0.964447317388494,0.615384615384615;0.989334195216548,0.957336780866193,0.538461538461538;0.987556561085973,0.950226244343891,0.461538461538462;0.985778926955398,0.943115707821590,0.384615384615385;0.984001292824822,0.936005171299289,0.307692307692308;0.982223658694247,0.928894634776988,0.230769230769231;0.980446024563672,0.921784098254686,0.153846153846154;0.978668390433096,0.914673561732385,0.0769230769230769;0.976890756302521,0.907563025210084,0;0.974789915966387,0.899159663865546,0;0.972689075630252,0.890756302521008,0;0.970588235294118,0.882352941176471,0;0.968487394957983,0.873949579831933,0;0.966386554621849,0.865546218487395,0;0.964285714285714,0.857142857142857,0;0.962184873949580,0.848739495798319,0;0.960084033613445,0.840336134453781,0;0.957983193277311,0.831932773109244,0;0.955882352941177,0.823529411764706,0;0.953781512605042,0.815126050420168,0;0.951680672268908,0.806722689075630,0;0.949579831932773,0.798319327731092,0;0.947478991596639,0.789915966386555,0;0.945378151260504,0.781512605042017,0;0.943277310924370,0.773109243697479,0;0.941176470588235,0.764705882352941,0;0.939075630252101,0.756302521008403,0;0.936974789915967,0.747899159663865,0;0.934873949579832,0.739495798319328,0;0.932773109243698,0.731092436974790,0;0.930672268907563,0.722689075630252,0;0.928571428571429,0.714285714285714,0;0.926470588235294,0.705882352941176,0;0.924369747899160,0.697478991596639,0;0.922268907563025,0.689075630252101,0;0.920168067226891,0.680672268907563,0;0.918067226890756,0.672268907563025,0;0.915966386554622,0.663865546218487,0;0.913865546218488,0.655462184873950,0;0.911764705882353,0.647058823529412,0;0.909663865546219,0.638655462184874,0;0.907563025210084,0.630252100840336,0;0.905462184873950,0.621848739495798,0;0.903361344537815,0.613445378151260,0;0.901260504201681,0.605042016806723,0;0.899159663865546,0.596638655462185,0;0.897058823529412,0.588235294117647,0;0.894957983193277,0.579831932773109,0;0.892857142857143,0.571428571428571,0;0.890756302521009,0.563025210084034,0;0.888655462184874,0.554621848739496,0;0.886554621848740,0.546218487394958,0;0.884453781512605,0.537815126050420,0;0.882352941176471,0.529411764705882,0;0.880252100840336,0.521008403361345,0;0.878151260504202,0.512605042016807,0;0.876050420168067,0.504201680672269,0;0.873949579831933,0.495798319327731,0;0.871848739495798,0.487394957983193,0;0.869747899159664,0.478991596638655,0;0.867647058823529,0.470588235294118,0;0.865546218487395,0.462184873949580,0;0.863445378151261,0.453781512605042,0;0.861344537815126,0.445378151260504,0;0.859243697478992,0.436974789915966,0;0.857142857142857,0.428571428571429,0;0.855042016806723,0.420168067226891,0;0.852941176470588,0.411764705882353,0;0.850840336134454,0.403361344537815,0;0.848739495798319,0.394957983193277,0;0.846638655462185,0.386554621848739,0;0.844537815126050,0.378151260504202,0;0.842436974789916,0.369747899159664,0;0.840336134453782,0.361344537815126,0;0.838235294117647,0.352941176470588,0;0.836134453781513,0.344537815126050,0;0.834033613445378,0.336134453781513,0;0.831932773109244,0.327731092436975,0;0.829831932773109,0.319327731092437,0;0.827731092436975,0.310924369747899,0;0.825630252100840,0.302521008403361,0;0.823529411764706,0.294117647058824,0;0.821428571428571,0.285714285714286,0;0.819327731092437,0.277310924369748,0;0.817226890756303,0.268907563025210,0;0.815126050420168,0.260504201680672,0;0.813025210084034,0.252100840336134,0;0.810924369747899,0.243697478991597,0;0.808823529411765,0.235294117647059,0;0.806722689075630,0.226890756302521,0;0.804621848739496,0.218487394957983,0;0.802521008403361,0.210084033613445,0;0.800420168067227,0.201680672268908,0;0.798319327731093,0.193277310924370,0;0.796218487394958,0.184873949579832,0;0.794117647058824,0.176470588235294,0;0.792016806722689,0.168067226890756,0;0.789915966386555,0.159663865546218,0;0.787815126050420,0.151260504201681,0;0.785714285714286,0.142857142857143,0;0.783613445378151,0.134453781512605,0;0.781512605042017,0.126050420168067,0;0.779411764705882,0.117647058823529,0;0.777310924369748,0.109243697478992,0;0.775210084033614,0.100840336134454,0;0.773109243697479,0.0924369747899160,0;0.771008403361345,0.0840336134453781,0;0.768907563025210,0.0756302521008404,0;0.766806722689076,0.0672268907563025,0;0.764705882352941,0.0588235294117646,0;0.762605042016807,0.0504201680672269,0;0.760504201680672,0.0420168067226890,0;0.758403361344538,0.0336134453781513,0;0.756302521008403,0.0252100840336135,0;0.754201680672269,0.0168067226890756,0;0.752100840336134,0.00840336134453790,0;0.750000000000000,0,0];
% colormap(KPD);
clear all
c=3e+10;
wp0=3e+9;

nu_tilda=0.5;
R2_tilda=0.5;
Delta=0.8;
R1_tilda=R2_tilda*(1-Delta);
theta=pi/2;
%R1_tilda=2.5;

nu=nu_tilda*wp0;
R1=R1_tilda*c/wp0;
R2=R2_tilda*c/wp0;

[b, fsound]=audioread ('mp3_last.mp3');
%% Const
j0=1;

dr=0.01*nu_tilda*(R2-R1);
dt=dr/(4*c);
% if dr/(2*c) > dr*cos(theta)/c
%     dt=dr*((1-2*cos(theta))/(2*c));
% else
%     dt=dr/(2*c);
% end
T_tilda=40;
timesteps=fix(T_tilda/(dt*wp0));
T=(dt:dt:(timesteps*dt))';

Rmax=R2*60;
r=(dr:dr:Rmax+dr)';
len=length(r);
NR1=ceil(R1/(dr));
if NR1==0
    NR1=1;
end
NR2=ceil(R2/(dr));
N_pml=10*NR2;%расстояние от R_max до начала PML
% MAIN_COEF=c*dt;
% SUB_COEF=0;
MAIN_COEF=c*dt/(sin(theta)^2);
SUB_COEF=cos(theta);

%f(r)
cosinus=cos(pi*((NR1:NR2)-NR1)/(2*(NR2-NR1)));
cosinus2=cosinus.^2;
Fr=ones(len,1);
Fr(NR1:NR2)=cosinus2;
Fr((NR2+1):len)=0;

r_alt=1./r;
r_tilda=r.*wp0/c;
%nu_tilda=nu/wp0;
%R2_tilda=R2*wp0/c;
%R1_tilda=R1*wp0/c;
R_max_tilda=Rmax*wp0/c;
N_pml_tilda=N_pml*dr*wp0/c;
%field_check_point=NR2+10;
field_check_point=NR2;
field_check_point_tilda=field_check_point*dr*wp0/c;
%% PML
sigma=ones(len,1);
cosinus_pml=cos((pi/2)*(((len-N_pml):len)-(len-N_pml))/(len-(len-N_pml)));
sigma((len+1-length(cosinus_pml)):len)=cosinus_pml;
%
%% НУ
Er=zeros(len,1);
Ep=zeros(len,1);
Ez=zeros(len,1);
Hr=zeros(len,1);
Hp=zeros(len,1);
Hz=zeros(len,1);
Jr=j0.*Fr;
Jp=-j0.*Fr;
Jz=zeros(len,1);
Ert=zeros(length(T),1);
Ept=Ert;
Ezt=Ert;
Hrt=Ert;
Hpt=Ert;
Hzt=Ert;
%% FDTD
fprintf(1,'R2 = %3.2f ;  delta = %3.2f ;  nu = %3.2f\n ',R2_tilda,Delta,nu_tilda); 
tic
for n=1:timesteps   
    %Jr
%     Jr=j0.*sin(5*wp0*n*dt).*Fr;
    Jr=Jr.*(1-dt*nu)+(dt*wp0^2/(4*pi)).*Fr.*Er;

    %Jp
%     Jp=-j0.*sin(5*wp0*n*dt).*Fr;
    Jp=Jp.*(1-dt*nu)+(dt*wp0^2/(4*pi)).*Fr.*Ep;

    %Jz
%     Jz=Jz;
    Jz=Jz.*(1-dt*nu)+(dt*wp0^2/(4*pi)).*Fr.*Ez;

    %Er V
    Er(1)=Er(2);
    for nr=2:len
        %Er(nr)=sigma(nr)*(Er(nr)+(c*dt*r_alt(nr))*Hz(nr)-(4*pi*dt)*Jr(nr));
        Er(nr)=sigma(nr).*(Er(nr)+MAIN_COEF*(r_alt(nr)*Hz(nr)-(4*pi/c)*Jr(nr)+SUB_COEF*(Ez(nr)-Ez(nr-1))/dr));
    end

    %Ephi V
    Ep(1)=Ep(2);
    for nr=2:len
        Ep(nr)=sigma(nr).*(Ep(nr)-(c*dt/dr)*(Hz(nr)-Hz(nr-1))-(4*pi*dt)*Jp(nr));
    end

    %Ez V
    for nr=1:len-1
       Ez(nr)=sigma(nr).*(Ez(nr)+(c*dt*r_alt(nr))*((Hp(nr+1)*r(nr+1)-Hp(nr)*r(nr))/dr-Hr(nr))-4*pi*dt*Jz(nr));
    end
    Ez(len)=0;

    %Hr V
    Hr(1)=Hr(2);
    for nr=2:len
       Hr(nr)=sigma(nr).*(Hr(nr)+MAIN_COEF*(r_alt(nr)*Ez(nr)+SUB_COEF*((Hz(nr)-Hz(nr-1))/dr+(4*pi/c)*Jp(nr))));
    end
    
    %Hphi V
    Hp(1)=Hp(2);
    for nr=2:len
       Hp(nr)=sigma(nr).*(Hp(nr)+MAIN_COEF*(SUB_COEF*(r_alt(nr)*Hz(nr)-(4*pi/c)*Jr(nr))+(Ez(nr)-Ez(nr-1))/dr));
    end

    %Hz
    for nr=1:(len-1)
        Hz(nr)=sigma(nr).*(Hz(nr)-(c*dt*r_alt(nr))*Er(nr)-(c*dt*r_alt(nr)/dr)*(r(nr+1)*Ep(nr+1)-r(nr)*Ep(nr)));
    end
    Hz(len)=sigma(len).*(Hz(len)-(c*dt*r_alt(len))*Er(len));

    Ert(n)=Er(ceil((field_check_point)));
    Ept(n)=Ep(ceil((field_check_point)));
    Ezt(n)=Ez(ceil((field_check_point)));
    Hrt(n)=Hr(ceil((field_check_point)));
    Hpt(n)=Hp(ceil((field_check_point)));
    Hzt(n)=Hz(ceil((field_check_point)));

    fprintf(1,'Шаг № = %3.0f / %3.0f\r',n,timesteps);
        
    %if n==fix(5/(dt*wp0))
    %if n==10
        %figure('Name','FDTD','NumberTitle','off','WindowState','maximized');
        %ploting_plasma        
    %end
    
    
end
toc
figure('Name','FDTD','NumberTitle','off','WindowState','maximized');
ploting_plasma 

%% Энергия
Wzap=(R2^2+R1^2)*((pi*j0)/wp0)^2; % Запасенная энергия
Wizl=c*(dt/4)*field_check_point*dr*integral(Ept,Hzt,timesteps); %Излучение
kpd=Wizl/Wzap;%КПД
%% Спектр
% figure('Name','Спектры','NumberTitle','off','WindowState','maximized');
Hzt_tilda=(wp0/(4*pi)).*Hzt;
fs=1/dt;%(F_max)
df=1/(16*max(T)); %частота дискретизации
f=0:df:fs; %Частотная сетка
NFs=fix(length(f));
NFn=fix(NFs/2);
f_tilda=2*pi*f./wp0; % Обезразмеренная частотная сетка
Y=fft(Hzt_tilda,NFs).*conj(fft(Hzt_tilda,NFs)); % Спектр по fft
Y_norm=Y./(max(Y));
tit=num2str(Delta); 

ploting_plasma_2

% fig=figure('Name','Спектр','NumberTitle','off','WindowState','maximized');
% hold on
% 
% plot(f_tilda(1:NFn),Y_norm(1:NFn),'Linewidth',1.5,'DisplayName',strcat('\delta=',tit))
% xlim([0 2*pi*0.8])
% xlabel('\omega / \omega_{p0}','Interpreter', 'tex','FontSize',12);
% ylabel('$S(\omega) / S_{0}$','Interpreter', 'latex','FontSize',12);
%% Last Plot ans Save
%fprintf(1,'R2 = %3.2f ;  delta = %3.2f ;  nu = %3.2f\n',R2_tilda,Delta,nu_tilda);
%figure('Name','FDTD','NumberTitle','off','WindowState','maximized');

%saveas(gcf,strcat('nu=',num2str(nu_tilda),'  R1=',num2str(R1_tilda),'  R2=',num2str(R2_tilda),'.png'))
%toc
%fprintf(1,'Шаг № %3.0f\n R2 =%3.5f\n R1 =%3.5f\n nu =%3.2f\n',n-1,R2_tilda,R1_tilda,nu_tilda);
% figure
% plot(5.*r_tilda(1:NR2),Fr(1:NR2))

sound (0.2*b,fsound);
